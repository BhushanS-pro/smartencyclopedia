<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Smart Encyclopedia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>
    // üîê Block access BEFORE page loads
    if (localStorage.getItem("smartencyclopedia_admin") !== "1") {
      window.location.replace("login.html");
    }
  </script>

  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
    header {
      background:#111827; color:#f9fafb; padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:20px; }
    header a { color:#93c5fd; text-decoration:none; font-size:13px; margin-right:10px; }
    .logout-btn {
      background:#b91c1c; border:none; color:#fff; padding:6px 10px;
      border-radius:4px; cursor:pointer; font-size:13px;
    }
    .logout-btn:hover { background:#991b1b; }

    .wrapper { max-width:1100px; margin:20px auto; padding:0 16px; }

    .tabs { display:flex; gap:8px; margin-bottom:16px; }
    .tab-btn {
      border:none; padding:8px 14px; border-radius:6px; cursor:pointer;
      background:#e5e7eb; font-size:14px;
    }
    .tab-btn.active { background:#2563eb; color:#fff; }

    .card {
      background:#fff; border-radius:10px; padding:16px;
      box-shadow:0 8px 25px rgba(15,23,42,.06); margin-bottom:16px;
    }
    label { display:block; margin-top:10px; font-size:14px; }
    input, textarea {
      width:100%; padding:9px; margin-top:4px; border-radius:6px;
      border:1px solid #d1d5db; font-size:14px;
    }
    textarea { resize:vertical; min-height:140px; }
    button.primary {
      margin-top:16px; padding:10px 16px; border-radius:6px; border:none;
      background:#2563eb; color:#fff; font-size:15px; cursor:pointer;
    }
    button.primary:hover { background:#1d4ed8; }
    .msg { margin-top:12px; font-size:14px; }
    .msg.success { color:#15803d; }
    .msg.error { color:#b91c1c; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px 6px; text-align:left; }
    th { background:#f9fafb; font-weight:600; font-size:13px; }
    tr:last-child td { border-bottom:none; }
    .actions button {
      border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;
      margin-right:4px;
    }
    .actions .edit { background:#2563eb; color:#fff; }
    .actions .delete { background:#b91c1c; color:#fff; }

    .pagination { margin-top:12px; display:flex; justify-content:flex-end; gap:4px; }
    .pagination button {
      border:1px solid #d1d5db; background:#fff; padding:4px 8px;
      border-radius:4px; font-size:12px; cursor:pointer;
    }
    .pagination button.active {
      background:#2563eb; color:#fff; border-color:#2563eb;
    }
  </style>
</head>
<body>

<header>
  <h1>Smart Encyclopedia ‚Äì Admin</h1>
  <div>
    <a href="index.html">‚Üê Back to site</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrapper">

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="add">Add Article</button>
    <button class="tab-btn" data-tab="manage">Manage Articles</button>
  </div>

  <!-- Add / Edit Form -->
  <div id="tab-add" class="card">
    <h2 id="form-title">Create New Article</h2>
    <form id="article-form">
      <label>Title
        <input type="text" id="title" required />
      </label>

      <label>Slug (URL, e.g. black-holes-explained)
        <input type="text" id="slug" required />
      </label>

      <label>Category (e.g. Science, History, Space)
        <input type="text" id="category" required />
      </label>

      <label>Image URL (optional ‚Äì for /public/images, use like: /images/filename.jpg)
        <input type="text" id="image_url" placeholder="/images/your-image.jpg" />
      </label>

      <label>Content (HTML or plain text)
        <textarea id="content" required></textarea>
      </label>

      <button type="submit" class="primary" id="submit-btn">Publish Article</button>
      <div id="form-message" class="msg"></div>
    </form>
  </div>

  <!-- Manage Articles -->
  <div id="tab-manage" class="card" style="display:none;">
    <h2>Manage Articles</h2>
    <div id="list-message" class="msg"></div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Slug</th>
            <th>Category</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="articles-body">
          <!-- rows injected here -->
        </tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

</div>

<script>
  const API_BASE = "";

  function logout() {
    localStorage.removeItem("smartencyclopedia_admin");
    window.location.replace("login.html");
  }

  // Tabs logic
  const tabButtons = document.querySelectorAll(".tab-btn");
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      document.getElementById("tab-add").style.display =
        btn.dataset.tab === "add" ? "block" : "none";
      document.getElementById("tab-manage").style.display =
        btn.dataset.tab === "manage" ? "block" : "none";

      if (btn.dataset.tab === "manage") {
        refreshArticles();
      }
    });
  });

  // Add / Edit form behavior
  let isEditing = false;
  let editingSlug = null;

  const form = document.getElementById("article-form");
  const formMsg = document.getElementById("form-message");
  const submitBtn = document.getElementById("submit-btn");
  const formTitle = document.getElementById("form-title");
  const slugInput = document.getElementById("slug");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    formMsg.textContent = "Saving...";
    formMsg.className = "msg";

    const payload = {
      title: document.getElementById("title").value.trim(),
      slug: slugInput.value.trim().toLowerCase().replace(/\s+/g, "-"),
      category: document.getElementById("category").value.trim(),
      image_url: document.getElementById("image_url").value.trim(),
      content: document.getElementById("content").value.trim()
    };

    try {
      let res;
      if (isEditing && editingSlug) {
        // UPDATE (PUT)
        res = await fetch(`${API_BASE}/api/article/${encodeURIComponent(editingSlug)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } else {
        // CREATE (POST)
        res = await fetch(`${API_BASE}/api/article/add-article`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }

      if (!res.ok) {
        throw new Error(await res.text());
      }

      formMsg.textContent = isEditing
        ? "‚úÖ Article updated successfully!"
        : "‚úÖ Article added successfully!";
      formMsg.className = "msg success";

      if (!isEditing) {
        form.reset();
      }

      // refresh list on manage tab
      if (document.querySelector('[data-tab="manage"]').classList.contains("active")) {
        refreshArticles();
      }

    } catch (err) {
      formMsg.textContent = "Error: " + err.message;
      formMsg.className = "msg error";
    }
  });

  function switchToEditMode(article) {
    isEditing = true;
    editingSlug = article.slug;

    formTitle.textContent = "Edit Article";
    submitBtn.textContent = "Update Article";

    document.getElementById("title").value = article.title || "";
    slugInput.value = article.slug || "";
    slugInput.disabled = true; // slug locked
    document.getElementById("category").value = article.category || "";
    document.getElementById("image_url").value = article.image_url || "";
    document.getElementById("content").value = article.content || "";

    // Switch to add/edit tab
    document.querySelector('.tab-btn[data-tab="add"]').click();
  }

  function resetCreateMode() {
    isEditing = false;
    editingSlug = null;
    formTitle.textContent = "Create New Article";
    submitBtn.textContent = "Publish Article";
    slugInput.disabled = false;
    form.reset();
    formMsg.textContent = "";
    formMsg.className = "msg";
  }

  // List / Pagination
  let allArticles = [];
  let currentPage = 1;
  const pageSize = 5;

  async function refreshArticles() {
    try {
      const res = await fetch(`${API_BASE}/api/articles`);
      if (!res.ok) throw new Error("Failed to load articles");
      allArticles = await res.json();
      currentPage = 1;
      renderArticles();
    } catch (err) {
      const listMsg = document.getElementById("list-message");
      listMsg.textContent = "Error loading articles: " + err.message;
      listMsg.className = "msg error";
    }
  }

  function renderArticles() {
    const tbody = document.getElementById("articles-body");
    const pag = document.getElementById("pagination");
    tbody.innerHTML = "";
    pag.innerHTML = "";

    if (!allArticles.length) {
      tbody.innerHTML = "<tr><td colspan='5'>No articles found.</td></tr>";
      return;
    }

    const totalPages = Math.ceil(allArticles.length / pageSize);
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const pageItems = allArticles.slice(start, start + pageSize);

    tbody.innerHTML = pageItems.map(a => {
      const created = a.created_at
        ? new Date(a.created_at).toLocaleDateString()
        : "";
      return `
        <tr>
          <td>${escapeHtml(a.title || "")}</td>
          <td>${escapeHtml(a.slug || "")}</td>
          <td>${escapeHtml(a.category || "")}</td>
          <td>${created}</td>
          <td class="actions">
            <button class="edit" onclick="onEditArticle('${encodeURIComponent(a.slug)}')">Edit</button>
            <button class="delete" onclick="onDeleteArticle('${encodeURIComponent(a.slug)}')">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    // Pagination buttons
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        renderArticles();
      });
      pag.appendChild(btn);
    }
  }

  async function onEditArticle(encodedSlug) {
    const slug = decodeURIComponent(encodedSlug);
    try {
      const res = await fetch(`${API_BASE}/api/article/${encodeURIComponent(slug)}`);
      if (!res.ok) throw new Error("Failed to load article");
      const article = await res.json();
      if (!article || !article.slug) throw new Error("Article not found");
      switchToEditMode(article);
    } catch (err) {
      alert("Error loading article for edit: " + err.message);
    }
  }

  async function onDeleteArticle(encodedSlug) {
    const slug = decodeURIComponent(encodedSlug);
    if (!confirm("Are you sure you want to delete this article?")) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/article/${encodeURIComponent(slug)}`, {
        method: "DELETE"
      });
      if (!res.ok) throw new Error(await res.text());
      // Remove from list and re-render
      allArticles = allArticles.filter(a => a.slug !== slug);
      renderArticles();
    } catch (err) {
      alert("Error deleting article: " + err.message);
    }
  }

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  // expose for inline handlers
  window.onEditArticle = onEditArticle;
  window.onDeleteArticle = onDeleteArticle;

  // Start in create mode
  resetCreateMode();
</script>

</body>
</html>
