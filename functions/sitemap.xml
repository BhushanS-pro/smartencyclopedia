export async function onRequestGet({ env }) {

  const base = "https://smartencyclopedia.uk";

  const categories = [
    "earth",
    "environment",
    "geography",
    "history",
    "human-body",
    "nature",
    "space",
    "technology"
  ];

  const articles = await env.articles_db
    .prepare("SELECT slug, category, created_at FROM articles ORDER BY created_at DESC")
    .all();

  const categoryUrls = categories.map(cat => `
    <url>
      <loc>${base}/${cat}</loc>
      <lastmod>${new Date().toISOString()}</lastmod>
      <changefreq>weekly</changefreq>
      <priority>0.8</priority>
    </url>
  `).join("");

  const articleUrls = articles.results.map(a => `
    <url>
      <loc>${base}/${a.category}/${a.slug}</loc>
      <lastmod>${new Date(a.created_at).toISOString()}</lastmod>
      <changefreq>monthly</changefreq>
      <priority>0.6</priority>
    </url>
  `).join("");

  return new Response(
    `<?xml version="1.0" encoding="UTF-8"?>
    <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">

      <url>
        <loc>${base}</loc>
        <lastmod>${new Date().toISOString()}</lastmod>
        <priority>1.0</priority>
      </url>

      ${categoryUrls}
      ${articleUrls}

    </urlset>`,
    { headers: { "Content-Type": "application/xml" } }
  );
}
